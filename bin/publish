#!/bin/bash

# while the port is listening, publish to etcd
while $(netstat -lnt | awk "\$6 == \"LISTEN\" && \$4 ~ \".$PORT\" && \$1 ~ \"$PROTO.\"" > /dev/null) ; do
	etcdctl -C $ETCD set $ETCD_PATH/host $HOST --ttl $ETCD_TTL >/dev/null
	etcdctl -C $ETCD set $ETCD_PATH/port $PORT --ttl $ETCD_TTL >/dev/null
	sleep $(($ETCD_TTL/2)) # sleep for half the TTL
done
